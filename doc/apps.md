# Text-based Desktop Environment

## Desktop Objects and Built-in Applications

 Type      | Object                         | Description
-----------|--------------------------------|----------------------
`teletype` | `Teletype Console`             | A solid rectangular truecolor text canvas depicting a freely scrollable buffer of the text runs generated by an xterm-compatible parser from the standard output of an attached CUI application. It can be a very heavy object due to maintaining a scrollback buffer of arbitrary length. Not used directly in the desktop process's address space.
`terminal` | `Terminal Console`             | A derivative of `Teletype Console` with additional UI controls.
`dtvt`     | `DirectVT Gateway`             | A lightweight truecolor text canvas depicting content received from an external dtvt-aware process.
`vtty`     | `Teletype Console dtvt‑bridge` | A `DirectVT Gateway` hosting an external standalone `Teletype Console` process. It is designed to run a heavy `Teletype Console` object in the external process's address space to optimize desktop resource consumption.
`term`     | `Terminal Console dtvt‑bridge` | A `DirectVT Gateway` hosting an external standalone `Terminal Console` process. It is designed to run a heavy `Terminal Console` object in the external process's address space to optimize desktop resource consumption.
`dtty`     | `DirectVT Gateway with TTY`    | A derivative of `DirectVT Gateway` stacked with additional limited `Teletype Console` as a controlling terminal. It is used for CUI applications that redirect DirectVT traffic to standard output and require user input via platform's TTY. Depending on activity the corresponding console became active for the user.
`tile`     | `Tiling Window Manager`        | A window container with an organization of the hosting window area into mutually non-overlapping panes for nested windows.
`site`     | `Desktop Region Marker`        | A transparent resizable frame for marking the specific desktop region for quick navigation across the borderless workspace.

## Terminal and Teletype Console

### Features

- Non-wrapped text output with horizontal scrolling support.
- Configurable scrollback buffer size (100k lines by default, limited by `max_int32` and system RAM).
- Search for text in the scrollback buffer.
- Linear and rectangular text selection for copying and searching.
- Full [VT2D](character_geometry.md) support.
- Shadow SGR attribute. See below for details.
- Support for several formats of copying the selected text:
  - Plain text
  - RTF
  - HTML
  - ANSI/VT
  - Protected (Windows platform only: `ExcludeClipboardContentFromMonitorProcessing`, `CanIncludeInClipboardHistory`, `CanUploadToCloudClipboard`)
- In-process Windows Console API Server of our implementation:
  - Win32 Console API support without Windows Console Host (conhost.exe) dependency.
  - Fullduplex passthrough VT input/output.
  - Support for OEM/National, UTF-8 and UTF-16 encodings.
  - Enforced ENABLE_WINDOW_INPUT mode.  
    Note: In fact it is a viewport resize event reporting. Viewport dimensions is always equal to the classic win32 console buffer dimensions.
  - Enforced ENABLE_PROCESSED_OUTPUT and ENABLE_VIRTUAL_TERMINAL_PROCESSING modes.
  - Disabled ENABLE_QUICK_EDIT_MODE mode.
  - Per process (not per process name) Windows Command Prompt (cmd.exe) input history, aka "Line input" or "Cooked read".
- Stdin/stdout logging.

### Private control sequences

Name         | Sequence                         | Description
-------------|----------------------------------|------------
`CCC_SBS`    | `CSI` 24 : n : m : q `p`         | Set scrollback buffer limits:<br>`n` Initial buffer size<br>`m` Grow step<br>`q` Grow limit
`CCC_SGR`    | `CSI` 28 : Pm `p`                | Set terminal background using SGR attributes (one attribute per call):<br>`Pm` Colon-separated list of attributes, 0 — reset all attributes, _default is 0_
`CCC_SEL`    | `CSI` 29 : n `p`                 | Set text selection mode:<br>`n = 0` Selection is off<br>`n = 1` Select and copy as plaintext (default)<br>`n = 2` Select and copy as ANSI/VT text<br>`n = 3` Select and copy as RTF-document<br>`n = 4` Select and copy as HTML-code<br>`n = 5` Select and copy as protected plaintext (suppressed preview, [details](https://learn.microsoft.com/en-us/windows/win32/dataxchg/clipboard-formats#cloud-clipboard-and-clipboard-history-formats))
`CCC_PAD`    | `CSI` 30 : n `p`                 | Set scrollback buffer left and right side padding:<br>`n` Width in cells, _max = 255, default is 0_
`CCC_RST`    | `CSI` 1 `p`                      | Reset all parameters to default
`CCC_TBS`    | `CSI` 5 : n `p`                  | Set tab length in cells:<br>`n` Length in cells, _max = 256, default is 8_
`CCC_JET`    | `CSI` 11 : n `p`                 | Set text alignment, _default is Left_:<br>`n = 0`<br>`n = 1` Left<br>`n = 2` Right<br>`n = 3` Center
`CCC_WRP`    | `CSI` 12 : n `p`                 | Set text autowrap mode, _default is On_:<br>`n = 0`<br>`n = 1` On<br>`n = 2` Off (_enables horizontal scrolling_)
`CCC_RTL`    | `CSI` 13 : n `p`                 | Set text right-to-left mode, _default is Off_:<br>`n = 0`<br>`n = 1` On<br>`n = 2` Off

Note: It is possible to combine multiple command into a single sequence using a semicolon. For example, the following sequence disables line wrapping, enables text selection, and sets background to blue: `\e[12:2;29:1;28:44p` or `\e[12:2;29:1;28:48:2:0:0:255p`.

### Shadow SGR attribute

Built-in terminal supports a shadow SGR attribute in form of 3x3 shadow cube:
- `CSI` 2 : n `m`  
  where n=0-255 is a bit field to specify shadows inside the cell.

```
Shadow bits:  0  1  2
              3 >n< 4
              5  6  7
```
Every bit drops the shadow inside the cell.

Shadows persist as an SGR attribute and are visible in GUI mode.

#### Examples
- The shadow around a 1x1 window:
  ```
   0  0  0   0  0  0   0  0  0
   0 >1< 0   0 >2< 0   0 >4< 0
   0  0  1   0  1  0   1  0  0
           ┌─────────┐        
   0  0  0 │         │ 0  0  0
   0 >8< 1 │  1x1    │ 1 >16<0
   0  0  0 │  Window │ 0  0  0
           └─────────┘        
   0  0  1   0  1  0   1  0  0
   0 >32<0   0 >64<0   0>128<0
   0  0  0   0  0  0   0  0  0
    ```
- 3x1 shadow (outer and inner), `pwsh`:
  ```pwsh
  "`e[107;30m";`
  "`e[2:1m `e[2:3m `e[2:7m `e[2:6m `e[2:4m ";`
  "`e[2:8m `e[2:0m A `e[2:16m ";`
  "`e[2:32m `e[2:96m `e[2:224m `e[2:192m `e[2:128m ";`
  " `e[2:247m `e[2:231mA`e[2:239m `e[2:0m ";`
  "     `e[m"
  
  ```
  ![image](https://github.com/user-attachments/assets/4c485864-7e50-4356-ad77-da65f2a5764e)

### VT2D support

The built-in terminal supports Unicode character geometry modifiers (VT2D). See [Unicode character Geometry Modifiers](character_geometry.md) for details.

Example 1. Output a 3x1 (31_00) character:
  - `pwsh`
    ```pwsh
    "👩‍👩‍👧‍👧`u{D009F}"
    ```
  - `bash`
    ```bash
    printf "👩‍👩‍👧‍👧\UD009F\n"
    ```
Example 2. Output a 6x2 character (by stacking two 6x1 fragments 62_01 and 62_02 on top of each other):
  - `pwsh`
    ```pwsh
    "👩‍👩‍👧‍👧`u{D0279}`n👩‍👩‍👧‍👧`u{D0312}"
    ```
  - `bash`
    ```bash
    printf "👩‍👩‍👧‍👧\UD0279\n👩‍👩‍👧‍👧\UD0312\n"
    ```
Example 3. Output a solid 9x3 character:
  - `pwsh`
    ```pwsh
    "👩‍👩‍👧‍👧`u{D03C3}"
    ```
  - `bash`
    ```bash
    printf "👩‍👩‍👧‍👧\UD03C3\n"
    ```
Example 4. Output the longest word in the Hindi language 16x1 (G1_00):
  - `pwsh`
    ```pwsh
    "`u{2}विश्वविज्ञानकोशनिर्माणसमिति`u{D0121}"
    ```
  - `bash`
    ```bash
    printf "\U2विश्वविज्ञानकोशनिर्माणसमिति\UD0121\n"
    ```
Screenshot:  
  ![image](images/vtm_character_geometry_modifiers_screenshot.png)

### Window menu

It is possible to create your own terminal window menu from scratch by configuring own menu items in the `<config/terminal/menu/>` subsection of the configuration file. See (`doc/settings.md#event-scripting`)[https://github.com/directvt/vtm/blob/master/doc/settings.md#event-scripting] for details.

Common syntax for window menu item declaration:

```xml
<config>
    <terminal>
        <menu>
            <item label="SomeLabelText">
                <script="Lua script body..." on="LeftClick"/>
                <tooltip>
                    " Tooltip text.      \n"
                    " Can be multi-line. "
                </tooltip>
            </item>
            ...
        </menu>
    </terminal>
</config>
```

### Default Hotkeys

List of hotkeys defined in the default configuration.

Hotkey                       | Description
-----------------------------|------------
`Ctrl-Alt \| Alt-Ctrl`       | Win32: Toggle exclusive keyboard mode.
`Alt+Shift+B`                | Unix: Toggle exclusive keyboard mode.
`Alt+RightArrow`             | Highlight next match of selected text fragment. Clipboard content is used if no active selection.
`Alt+LeftArrow`              | Highlight previous match of selected text fragment. Clipboard content is used if no active selection.
`Ctrl+Shift+PageUp`          | Scroll one page up.
`Ctrl+Shift+PageDown`        | Scroll one page down.
`Alt+Shift+LeftArrow`        | Scroll one page to the left.
`Alt+Shift+RightArrow`       | Scroll one page to the right.
`Ctrl+Shift+UpArrow`         | Scroll one line up.
`Ctrl+Shift+DownArrow`       | Scroll one line down.
`Ctrl+Shift+LeftArrow`       | Scroll one cell to the left.
`Ctrl+Shift+RightArrow`      | Scroll one cell to the right.
`Ctrl+Shift+Home`            | Scroll to the scrollback top.
`Ctrl+Shift+End`             | Scroll to the scrollback bottom (reset viewport position).
`Ctrl+Insert`                | Copy selection to the clipboard if it is.
`Shift+Insert`               | Paste from clipboard.
`Esc`                        | Deselect a selection if it is.

### Configuration example

```xml
<OnLeftClick on="LeftClick"/>
<config>
    <terminal>
        <menu item*>
            <item label="  " tooltip=" just empty menu item "/>
            <item id="test_button" label=" Repeatable button " tooltip=" test ">
                <script on="MouseDown">  <!-- Script to colorize the pressed label (by any mouse button) and printing 'Test' while it is pressed. -->
                    if (not vtm.gear.IsKeyRepeated()) then    -- First run - colorize label and activate the mouse button to repeat.
                        vtm.test_button.Label("\e[44m Repeatable button \e[m")
                        vtm.test_button.Deface()
                        vtm.gear.RepeatWhilePressed(vtm.test_button)    -- Capture (by vtm.test_button) the mouse and trigger the mouse button event to repeat while pressed.
                    end
                    vtm.terminal.Print('Test\\n')
                </script>
                <script on="MouseUp">  <!-- Script to restore default label state. -->
                    vtm.test_button.Label(" Repeatable button ")    -- Restore default colors.
                    vtm.test_button.Deface()
                </script>
            </item>
            <item label="  Restart  "       script=OnLeftClick | TerminalRestart                    />
            <item label="  End  "           script=OnLeftClick | TerminalScrollViewportToEnd        />
            <item label="  Top  "           script=OnLeftClick | TerminalScrollViewportToTop        />
            <item label="  PgLeft  "        script=OnLeftClick | TerminalScrollViewportOnePageLeft  />
            <item label="  PgRight  "       script=OnLeftClick | TerminalScrollViewportOnePageRight />
            <item label="  PgUp  "          script=OnLeftClick | TerminalScrollViewportOnePageUp    />
            <item label="  PgDn  "          script=OnLeftClick | TerminalScrollViewportOnePageDown  />
            <item label="  CharLeft  "      script=OnLeftClick | TerminalScrollViewportOneCellLeft  />
            <item label="  CharRight  "     script=OnLeftClick | TerminalScrollViewportOneCellRight />
            <item label="  LineUp  "        script=OnLeftClick | TerminalScrollViewportOneLineUp    />
            <item label="  LineDn  "        script=OnLeftClick | TerminalScrollViewportOneLineDown  />
            <item label="  PrnScr  "        script=OnLeftClick | TerminalCopyViewport               />
            <item label="  Deselect  "      script=OnLeftClick | TerminalSelectionCancel            />
            <item label="  SelectionForm  " script=OnLeftClick | TerminalSelectionForm              />
            <item label="  Copy  "          script=OnLeftClick | TerminalCopySelection              />
            <item label="  Paste  "         script=OnLeftClick | TerminalClipboardPaste             />
            <item label="  Wipe  "          script=OnLeftClick | TerminalClipboardWipe              />
            <item label="  Undo  "          script=OnLeftClick | TerminalUndo                       />
            <item label="  Redo  "          script=OnLeftClick | TerminalRedo                       />
            <item label="  Quit  "          script=OnLeftClick | CloseApplet                        />
            <item label="  Fullscreen  "    script=OnLeftClick | FullscreenApplet                   />
            <item label="  Maximize  "      script=OnLeftClick | MaximizeApplet                     />
            <item label="  Minimize  "      script=OnLeftClick | MinimizeApplet                     />
            <item label="  CwdSync  ">
                <script=OnLeftClick | TerminalCwdSync/>
                <script>  <!-- A binding to update the menu item label at runtime. -->
                    <on="preview: terminal::events::toggle::cwdsync" source="terminal"/>
                    local state=vtm()                   -- Use event arguments to get the current state.
                    vtm.item.Label(state==1 and "\\x1b[38:2:0:255:0m  CwdSync  \\x1b[m" or "  CwdSync  ")
                    vtm.item.Tooltip(state==1 and " CWD sync is on                          \\n Make sure your shell has OSC9;9 enabled " or " CWD sync is off ")
                    vtm.item.Deface()
                </script>
            </item>
            <item label="  Hello, World! " tooltip=" Simulate keypresses " script=OnLeftClick | TerminalSendKey/>
            <item label="  Push Me  "      tooltip=" test "                script="vtm.terminal.Print('\\x1b[37mPush Me\\x1b[m')" | OnLeftClick/>
            <item label="  One-Shot  " script=OnLeftClick | TerminalSelectionOneShot>
                <tooltip>
                    " One-shot toggle to select and copy text \n"
                    " while mouse tracking is active.         "
                </tooltip>
            </item>
        </menu>
    </terminal>
    <events>  <!-- The required key combination sequence can be generated on the Info page, accessible by clicking on the label in the lower right corner of the vtm desktop. The 'key*' statement here is to clear all previous bindings and start a new list. -->
        <terminal script*>  <!-- Terminal bindings. -->
            <script=ExclusiveKeyboardMode              on="preview: Alt+Shift+B"/>
            <script="vtm.gear.SetHandled()"            on="Esc"/> <!-- Do nothing. We use the Esc key as a modifier. Its press+release events will only be sent after the key is physically released, and only if no other keys were pressed along with Esc. -->
            <script                                    on="-Esc">  --  Clear selection if it is and send Esc press and release events.
                vtm.terminal.ClearSelection()
                vtm.terminal.KeyEvent({ virtcod=0x1b, scancod=1, keystat=1, cluster='\\u{1b}' }, { virtcod=0x1b, scancod=1, keystat=0 })
            </script>
            <script=TerminalFindNext                   on="Alt+RightArrow"       />
            <script=TerminalFindPrev                   on="Alt+LeftArrow"        />
            <script=TerminalScrollViewportOnePageUp    on="Shift+Ctrl+PageUp"    />
            <script=TerminalScrollViewportOnePageDown  on="Shift+Ctrl+PageDown"  />
            <script=TerminalScrollViewportOnePageLeft  on="Shift+Alt+LeftArrow"  />
            <script=TerminalScrollViewportOnePageRight on="Shift+Alt+RightArrow" />
            <script=TerminalScrollViewportOneLineUp    on="Shift+Ctrl+UpArrow"   />
            <script=TerminalScrollViewportOneLineDown  on="Shift+Ctrl+DownArrow" />
            <script=TerminalScrollViewportOneCellLeft  on="Shift+Ctrl+LeftArrow" />
            <script=TerminalScrollViewportOneCellRight on="Shift+Ctrl+RightArrow"/>
            <script=TerminalScrollViewportToTop        on="Shift+Ctrl+Home"      />
            <script=TerminalScrollViewportToEnd        on="Shift+Ctrl+End"       />
            <script=TerminalSendKey                    on=""                     />
            <script=TerminalReset                      on=""                     />
            <script=TerminalClearScrollback            on=""                     />
            <script=TerminalCopyViewport               on=""                     />
            <script=TerminalCopySelection              on="preview:Ctrl+Insert"  />
            <script=TerminalClipboardPaste             on="preview:Shift+Insert" />
            <script=TerminalClipboardWipe              on=""                     />
            <script=TerminalClipboardFormat            on=""                     />
            <script=TerminalSelectionForm              on=""                     />
            <script=TerminalSelectionOneShot           on=""                     />
            <script=TerminalUndo                       on=""                     />
            <script=TerminalRedo                       on=""                     />
            <script=TerminalCwdSync                    on=""                     />
            <script=TerminalWrapMode                   on=""                     />
            <script=TerminalAlignMode                  on=""                     />
            <script=TerminalStdioLog                   on=""                     />
            <script=TerminalRestart                    on=""                     />
        </terminal>
    </events>
</config>
```

## DirectVT Gateway

DirectVT Gateway is used to attach DirectVT-aware sources. It is mainly used to receive DirectVT traffic from an external dtvt-endpoint.

## DirectVT Gateway with TTY

DirectVT Gateway with TTY is used when there is a need for interactive interaction with the user through the controlling terminal. For example, this is required when connecting via SSH with keyboard-interactive authentication or requesting a private key passphrase.

In case of running in standalone mode this window object type is used automatically if the first command line argument begins with `ssh` keyword.

The following commands are identical:
```
vtm -r dtty ssh user@host vtm
```
```
vtm ssh user@host vtm
```

## Desktop Region Marker

The Desktop Region Marker is used to quickly navigate the desktop by left-clicking on an instance in the taskbar. The region title can be set using the clipboard text data by right-clicking once on the region frame (swap clipboard text with title text).

## Tiling Window Manager

Tiling Window Manager is a window container that organizes the workspace into mutually non-overlapping panes for nested windows.

### Features

- Supports Drag and Drop for panes (like tabs in a browser). Use any modifiers (`Ctrl` or `Alt`) while pane dragging to suppress this functionality.
- For convenient management of running applets, there is a parallel list of them on the right side of the Tile Manager window:
  - `LeftClick` -- To set exclusive focus for applet.
  - `Ctrl+LeftClick` -- To set/unset group focus.
  - `LeftDoubleClick` -- Maximize/Restore selected applet.
- It is configurable via settings (See configuration example in doc\settings.md`).

### Configuration example

```xml
<OnLeftClick on="LeftClick"/>
<Menu>
    <Defaults>
        <autohide=false/>  <!-- Auto hide window menu items on mouse leave. -->
        <slim=true/>       <!-- Make the window menu one cell high (slim=true) or three cells high (slim=false). -->
    </Defaults>
</Menu>
<config>
    <tile>
        <menu item*>
            <autohide=/Menu/Defaults/autohide/>
            <slim=/Menu/Defaults/slim/>
            <item label="  " tooltip=" AlwaysOnTop off " script=OnLeftClick | AlwaysOnTopApplet> <!-- The default event source is the parent object, i.e. source="item" (aka vtm.item). -->
                <script>  <!-- A binding to update the menu item label at runtime. -->
                    <on="release: e2::form::prop::zorder" source="applet"/>
                    local is_topmost=vtm()                   -- Use event arguments to get the current state.
                    -- local is_topmost=vtm.applet.ZOrder()  -- or ask the object itself for the current state.
                    vtm.item.Label(is_topmost==1 and "\\x1b[38:2:0:255:0m▀ \\x1b[m" or "  ")
                    vtm.item.Tooltip(is_topmost==1 and " AlwaysOnTop on " or " AlwaysOnTop off ")
                    vtm.item.Deface()
                </script>
            </item>
            <item label="   +   ">
                <script=TileRunApplication on="LeftClick"/>
                <tooltip>
                    " Launch application instances in active empty slots.     \n"
                    " The app to run can be set by RightClick on the taskbar. "
                </tooltip>
            </item>
            <item label="  :::  " tooltip=" Select all panes "                                     script=OnLeftClick | TileSelectAllPanes     />
            <item label="   │   " tooltip=" Split active panes horizontally "                      script=OnLeftClick | TileSplitHorizontally  />
            <item label="  ──  "  tooltip=" Split active panes vertically "                        script=OnLeftClick | TileSplitVertically    />
            <item label="  ┌┘  "  tooltip=" Change split orientation "                             script=OnLeftClick | TileSplitOrientation   />
            <item label="  <->  " tooltip=" Swap two or more panes "                               script=OnLeftClick | TileSwapPanes          />
            <item label="  >|<  " tooltip=" Equalize split ratio "                                 script=OnLeftClick | TileEqualizeSplitRatio />
            <item label='  "…"  ' tooltip=" Set tiling window manager title using clipboard data " script=OnLeftClick | TileSetManagerTitle    />
            <item label="  ×  "   tooltip=" Close active application "                             script=OnLeftClick | TileClosePane          />
            <!-- <item label="  <  "   tooltip=" Focus the previous pane or the split grip " script=OnLeftClick | TileFocusPrev    /> -->
            <!-- <item label="  >  "   tooltip=" Focus the next pane or the split grip "     script=OnLeftClick | TileFocusNext    /> -->
            <!-- <item label="  <-  "  tooltip=" Focus the previous pane "                   script=OnLeftClick | TileFocusPrevPane/> -->
            <!-- <item label="  ->  "  tooltip=" Focus the next pane "                       script=OnLeftClick | TileFocusNextPane/> -->
        </menu>
    </tile>
    <events>
        <tile script*>
            <script=TileFocusPrev          on="Ctrl+PageUp"    />
            <script=TileFocusNext          on="Ctrl+PageDown"  />
            <script=TileFocusPrevPane      on=""               />
            <script=TileFocusNextPane      on=""               />
            <script=TileRunApplication     on="Alt+Shift+N"    />
            <script=TileSelectAllPanes     on="Alt+Shift+A"    />
            <script=TileSplitHorizontally  on="Alt+Shift+'|'"  />
            <script=TileSplitVertically    on="Alt+Shift+Minus"/>
            <script=TileSplitOrientation   on="Alt+Shift+R"    />
            <script=TileSwapPanes          on="Alt+Shift+S"    />
            <script=TileEqualizeSplitRatio on="Alt+Shift+E"    />
            <script=TileSetManagerTitle    on="Alt+Shift+F2"   />
            <script=TileClosePane          on="Alt+Shift+W"    />
            <grip script*>
                <script=TileMoveGripLeft      on="LeftArrow"                         />
                <script=TileMoveGripRight     on="RightArrow"                        />
                <script=TileMoveGripUp        on="UpArrow"                           />
                <script=TileMoveGripDown      on="DownArrow"                         />
                <script=TileDecreaseGripWidth on="'-'"                               />
                <script=TileIncreaseGripWidth on="Shift+'+' | '+' | '=' | NumpadPlus"/>
                <script=TileFocusPrevGrip     on="Shift+Tab"                         />
                <script=TileFocusNextGrip     on="Tab"                               />
            </grip>
        </tile>
    </events>
</config>
```